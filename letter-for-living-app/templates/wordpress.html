<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WordPress Automation</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <nav class="top-nav">
      <a href="/">홈</a>
      <a href="/planner">작업플래너</a>
      <a href="/blog">블로그자동화</a>
      <a href="/shorts">영상자동화</a>
      <a href="/wordpress">워드프레스 자동화</a>
      <a href="/settings">설정</a>
    </nav>
    <main class="layout full single">
      <section class="content">
        <header class="hero">
          <h1>워드프레스 자동화</h1>
          <p>워드프레스 글 생성과 게시 흐름을 준비합니다.</p>
        </header>

        <section class="panel">
          <div class="panel-header">
            <h2>생성옵션설정</h2>
            <button type="submit" form="keywordForm" class="confirm-button">
              키워드 생성
            </button>
          </div>
          <form method="post" id="keywordForm">
            <input type="hidden" name="action" value="generate_keywords" />
          </form>
          <div class="form-row">
            <div class="label-col">키워드 선택</div>
            <div class="field-col">
              {% if keyword_list %}
              <form method="post" id="articleForm">
                <input type="hidden" name="action" value="generate_wordpress" />
                <div class="keyword-list">
                  {% for keyword in keyword_list %}
                  <label class="keyword-option">
                    <input
                      type="radio"
                      name="selected_keyword"
                      value="{{ keyword }}"
                      {% if selected_keyword == keyword %}checked{% endif %}
                    />
                    <span>{{ keyword }}</span>
                  </label>
                  {% endfor %}
                </div>
              </form>
              {% else %}
              <p>키워드를 먼저 생성해 주세요.</p>
              {% endif %}
            </div>
          </div>
          <div class="form-row">
            <div class="label-col">글 생성</div>
            <div class="field-col">
              <button type="submit" form="articleForm" class="confirm-button">
                글 생성하기
              </button>
            </div>
          </div>
        </section>

        <section class="panel result">
          <div class="panel-header">
            <h2>생성 결과</h2>
          </div>
          <div class="result-card">
            <div class="card-content">
              {% if wordpress_result %}
              <div class="prompt-row">
                <button type="button" class="ghost-link" id="copyWordpressResult">
                  복사
                </button>
              </div>
              <pre class="markdown-output">{{ wordpress_result }}</pre>
              {% else %}
              <p>아직 생성된 글이 없습니다.</p>
              {% endif %}
            </div>
            <div class="card-skeleton" aria-hidden="true">
              <span class="skeleton-line"></span>
              <span class="skeleton-line"></span>
              <span class="skeleton-line short"></span>
            </div>
          </div>
        </section>
      </section>
    </main>
    {% if error %}
    <div class="toast" data-message="{{ error }}"></div>
    {% elif notice %}
    <div class="toast" data-message="{{ notice }}"></div>
    {% endif %}
    <script>
      const toastEl = document.querySelector(".toast");
      const resultPanel = document.querySelector(".panel.result");

      const showToast = (message) => {
        if (!message) return;
        const container = document.createElement("div");
        container.className = "toast-container";
        container.textContent = message;
        document.body.appendChild(container);
        setTimeout(() => container.classList.add("show"), 10);
        setTimeout(() => {
          container.classList.remove("show");
          setTimeout(() => container.remove(), 300);
        }, 3000);
      };

      const setBusy = (message) => {
        if (resultPanel) {
          resultPanel.classList.add("loading");
        }
        document.body.classList.add("busy");
        document.querySelectorAll("button").forEach((btn) => {
          btn.disabled = true;
        });
        showToast(message);
      };

      if (toastEl && toastEl.dataset.message) {
        showToast(toastEl.dataset.message);
      }

      const copyBtn = document.getElementById("copyWordpressResult");
      const markdownOutput = document.querySelector(".markdown-output");
      if (copyBtn && markdownOutput) {
        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(markdownOutput.textContent || "");
            copyBtn.textContent = "복사됨";
            setTimeout(() => {
              copyBtn.textContent = "복사";
            }, 1500);
          } catch (err) {
            copyBtn.textContent = "복사 실패";
          }
        });
      }

      const keywordForm = document.getElementById("keywordForm");
      if (keywordForm) {
        keywordForm.addEventListener("submit", () => {
          setBusy("키워드 생성 중...");
        });
      }

      const articleForm = document.getElementById("articleForm");
      if (articleForm) {
        articleForm.addEventListener("submit", () => {
          setBusy("글 생성 중...");
        });
      }
    </script>
  </body>
</html>
